import{_ as j,x as ee,h as te,u as se,c as H,i as _,o as ae,s as le,a as i,b as o,d as l,t as c,l as y,q as B,F as I,p as S,g as ne,m as T,n as N}from"./index-358441f2.js";const ie={class:"container py-4"},oe={key:0,class:"text-center py-5"},re={key:1,class:"alert alert-danger"},de={key:2,class:"row"},ue={class:"col-md-8"},ce={class:"card shadow-sm"},ve={class:"card-header d-flex justify-content-between align-items-center py-3"},pe={key:0,class:"text-muted small"},ye={class:"card-body p-0"},me={class:"game-board"},_e={class:"board-container"},ge={class:"board",ref:"boardRef"},fe={class:"board-grid"},he=["onClick"],be={key:0,class:"last-move-mark"},we={class:"col-md-4"},xe={class:"card shadow-sm mb-4"},ke={class:"card-body"},Ce={key:0,class:"player-info"},$e={class:"player mb-3"},Fe={class:"player-details"},Ie={class:"player-name"},Se={key:0,class:"player-status"},Te={class:"player mb-3"},Ee={class:"player-details"},Me={class:"player-name"},Re={key:0,class:"player-status"},Le={class:"game-stats mb-3"},Be={class:"stat-item"},Ne={class:"stat-value"},Ve={class:"stat-item"},qe={class:"stat-value"},Ae={class:"stat-item"},ze={key:0,class:"alert alert-info"},Ge={key:1,class:"alert alert-success"},He={key:0},Pe={key:1},Oe=20*1e3,De={__name:"GameView",setup(We){const P=ee(),E=te(),V=se(),g=H(()=>V.user||{}),f=H(()=>P.params.id),e=_(null),m=_([]),b=_(!0),v=_(null),M=_(!1),x=_(null),h=_(1800);let p=null,k=null,C=null;const q=()=>e.value?e.value.player1_id===g.value.id?"你 (黑棋)":e.value.player1_username+" (黑棋)":"Player 1",A=()=>!e.value||!e.value.player2_id?"等待玩家加入...":e.value.player2_id===g.value.id?"你 (白棋)":e.value.player2_username+" (白棋)",z=()=>{if(!e.value)return"未知";switch(e.value.status){case"waiting":return"等待对手加入";case"playing":return"游戏进行中";case"finished":return"游戏结束";case"abandoned":return"游戏已放弃";default:return"未知状态"}},O=()=>{if(!e.value)return"status-unknown";switch(e.value.status){case"waiting":return"status-waiting";case"playing":return"status-playing";case"finished":return"status-finished";case"abandoned":return"status-abandoned";default:return"status-unknown"}},R=(n,s)=>{if(!m.value)return null;const a=m.value.find(t=>t.x===n&&t.y===s);return a?a.player_id===e.value.player1_id?1:2:null},D=(n,s)=>x.value?x.value.x===n&&x.value.y===s:!1,W=async(n,s)=>{var a,t,r;if(!(!M.value||!e.value||e.value.status!=="playing")&&!R(n,s))try{const d=await T.post(`/api/games/${f.value}/move`,{x:n,y:s});if(d.data&&d.data.status==="success"){if(d.data.game_over)return;await L()}else v.value=((a=d.data)==null?void 0:a.message)||"下棋失败，请重试"}catch(d){console.error("Failed to make move:",d);const w=((r=(t=d.response)==null?void 0:t.data)==null?void 0:r.message)||d.message||"未知错误";w.includes("不是您的回合")?alert("请不要连击哦~"):w.includes("违反三三禁手")?alert("违反三三禁手规则！"):v.value="下棋失败："+w}},X=n=>{if(typeof n!="number")return"00:00";const s=Math.floor(n/60),a=n%60;return`${s.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},J=()=>{confirm("确定要退出游戏吗？如果游戏正在进行中，退出将视为认输并扣除10积分。")&&G()},G=async()=>{var n,s,a;try{const t=await T.post(`/api/games/${f.value}/exit`);t.data&&t.data.status==="success"?(t.data.points_change&&alert(`游戏已结束。您的积分变更: ${t.data.points_change>0?"+"+t.data.points_change:t.data.points_change}`),E.push("/")):v.value=((n=t.data)==null?void 0:n.message)||"退出游戏失败，请重试"}catch(t){console.error("Failed to exit game:",t),v.value="退出游戏失败："+(((a=(s=t.response)==null?void 0:s.data)==null?void 0:a.message)||t.message||"未知错误")}},U=()=>{h.value>0&&e.value&&e.value.status==="playing"&&(h.value--,h.value===0&&G())},L=async()=>{var n,s,a;try{const t=await T.get(`/api/games/${f.value}`);if(t.data){const r=(n=e.value)==null?void 0:n.status;e.value=t.data,m.value=t.data.moves||[],m.value.length>0&&(x.value=m.value[m.value.length-1]),e.value.status==="playing"&&(M.value=e.value.current_player_id===g.value.id),r!=="playing"&&e.value.status==="playing"&&(e.value.time_limit&&(h.value=e.value.time_limit),p||(p=setInterval(U,1e3))),r==="playing"&&(e.value.status==="finished"||e.value.status==="abandoned")&&K()}b.value&&(b.value=!1)}catch(t){console.error("Failed to fetch game:",t),b.value&&(v.value="获取游戏数据失败："+(((a=(s=t.response)==null?void 0:s.data)==null?void 0:a.message)||t.message||"未知错误"),b.value=!1)}},K=()=>{if(p&&(clearInterval(p),p=null),e.value.status!=="finished"&&e.value.status!=="abandoned")return;const n=document.getElementById("game-result-container");if(n&&n.remove(),!e.value.winner_id)return;const s=e.value.winner_id===g.value.id,a=document.createElement("div");a.id="game-result-container",a.style.position="fixed",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.display="flex",a.style.flexDirection="column",a.style.justifyContent="center",a.style.alignItems="center",a.style.backgroundColor="rgba(0, 0, 0, 0.75)",a.style.zIndex="9999",a.style.opacity="0",a.style.transition="opacity 0.5s ease";const t=document.createElement("div");s?(t.textContent="胜利!",t.style.color="#4CAF50",t.style.textShadow="0 0 10px rgba(76, 175, 80, 0.7)"):(t.textContent="失败!",t.style.color="#F44336",t.style.textShadow="0 0 10px rgba(244, 67, 54, 0.7)"),t.style.fontSize="72px",t.style.fontWeight="bold",t.style.marginBottom="20px",t.style.transform="scale(0.1)",t.style.transition="transform 0.5s ease";const r=document.createElement("div");r.style.color="#FFFFFF",r.style.fontSize="24px",r.style.marginBottom="30px",r.style.textAlign="center",r.style.opacity="0",r.style.transition="opacity 0.5s ease 0.3s";let d="";e.value.status==="abandoned"?e.value.points_change&&(d=`积分变更: ${e.value.points_change>0?"+"+e.value.points_change:e.value.points_change}`):s?d="你获得了+10积分！":d="你失去了10积分。";const w=s?"你":e.value.winner_id===e.value.player1_id?e.value.player1_username:e.value.player2_username;r.innerHTML=`${w}获胜！<br>${d}`;const u=document.createElement("div");u.style.color="#FFFFFF",u.style.fontSize="18px",u.style.marginTop="20px",u.style.padding="10px 20px",u.style.backgroundColor="rgba(255, 255, 255, 0.2)",u.style.borderRadius="20px",u.style.opacity="0",u.style.transition="opacity 0.5s ease 0.6s",a.appendChild(t),a.appendChild(r),a.appendChild(u),document.body.appendChild(a),setTimeout(()=>{a.style.opacity="1",t.style.transform="scale(1)",setTimeout(()=>{r.style.opacity="1",setTimeout(()=>{u.style.opacity="1";let F=5;u.textContent=`${F}秒后返回主页`;const Z=setInterval(()=>{F--,u.textContent=`${F}秒后返回主页`,F<=0&&(clearInterval(Z),a.style.opacity="0",setTimeout(()=>{a.remove(),E.push("/")},500))},1e3)},300)},300)},100)},Q=()=>{p&&(clearInterval(p),p=null),k&&(clearInterval(k),k=null),C&&(clearInterval(C),C=null)},Y=async()=>{if(!(!e.value||e.value.status!=="playing"))try{await T.post(`/api/games/${f.value}/heartbeat`)}catch(n){console.error("Failed to send heartbeat:",n)}};ae(async()=>{if(!V.isAuthenticated){E.push("/login");return}try{await L(),k=setInterval(L,1e3),C=setInterval(Y,Oe),window.addEventListener("beforeunload",$),window.addEventListener("pagehide",$)}catch(n){console.error("Error loading game:",n),v.value="加载游戏数据失败，请刷新页面重试"}}),le(()=>{Q(),window.removeEventListener("beforeunload",$),window.removeEventListener("pagehide",$)});const $=n=>{if(e.value&&e.value.status==="playing"&&(e.value.player1_id===g.value.id||e.value.player2_id===g.value.id)){try{const s=`/api/games/${f.value}/exit`;if(!navigator.sendBeacon(s,JSON.stringify({}))){const t=new XMLHttpRequest;t.open("POST",s,!1),t.setRequestHeader("Content-Type","application/json"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.withCredentials=!0,t.send(JSON.stringify({})),t.status!==200&&console.error("Failed to send exit request on page close, status:",t.status)}}catch(s){console.error("Failed to send exit request on page close:",s)}return n.returnValue="游戏还在进行中，离开将视为认输！",n.returnValue}};return(n,s)=>(i(),o("div",ie,[b.value?(i(),o("div",oe,s[0]||(s[0]=[l("div",{class:"spinner-border text-primary",role:"status"},[l("span",{class:"visually-hidden"},"加载中...")],-1),l("p",{class:"mt-3"},"正在加载游戏...",-1)]))):v.value?(i(),o("div",re,c(v.value),1)):(i(),o("div",de,[l("div",ue,[l("div",ce,[l("div",ve,[l("div",null,[s[1]||(s[1]=l("h4",{class:"mb-0"},"五子棋对战",-1)),e.value?(i(),o("div",pe,"游戏ID: "+c(f.value),1)):y("",!0)]),l("div",{class:B(["status-badge",O()])},c(z()),3)]),l("div",ye,[l("div",me,[l("div",_e,[l("div",ge,[l("div",fe,[(i(),o(I,null,S(15,a=>l("div",{key:`h-${a}`,class:"grid-line horizontal",style:N({top:`${(a-1)*100/14}%`})},null,4)),64)),(i(),o(I,null,S(15,a=>l("div",{key:`v-${a}`,class:"grid-line vertical",style:N({left:`${(a-1)*100/14}%`})},null,4)),64)),s[2]||(s[2]=ne('<div class="mark-point" style="top:calc(7 * 100% / 14);left:calc(7 * 100% / 14);" data-v-c28b74cd></div><div class="mark-point" style="top:calc(3 * 100% / 14);left:calc(3 * 100% / 14);" data-v-c28b74cd></div><div class="mark-point" style="top:calc(3 * 100% / 14);left:calc(11 * 100% / 14);" data-v-c28b74cd></div><div class="mark-point" style="top:calc(11 * 100% / 14);left:calc(3 * 100% / 14);" data-v-c28b74cd></div><div class="mark-point" style="top:calc(11 * 100% / 14);left:calc(11 * 100% / 14);" data-v-c28b74cd></div>',5))]),(i(),o(I,null,S(15,a=>l("div",{key:`row-${a}`,class:"board-row"},[(i(),o(I,null,S(15,t=>l("div",{key:`point-${a}-${t}`,class:"board-point",style:N({top:`${(a-1)*100/14}%`,left:`${(t-1)*100/14}%`}),onClick:r=>W(a-1,t-1)},[R(a-1,t-1)?(i(),o("div",{key:0,class:B(["stone",R(a-1,t-1)===1?"stone-black":"stone-white"])},[D(a-1,t-1)?(i(),o("div",be)):y("",!0)],2)):y("",!0)],12,he)),64))])),64))],512)])])])])]),l("div",we,[l("div",xe,[s[12]||(s[12]=l("div",{class:"card-header py-3"},[l("h5",{class:"mb-0"},"对战信息")],-1)),l("div",ke,[e.value?(i(),o("div",Ce,[l("div",$e,[s[4]||(s[4]=l("div",{class:"stone-icon stone-black"},null,-1)),l("div",Fe,[l("div",Ie,c(q()),1),e.value.current_player_id===e.value.player1_id?(i(),o("div",Se,s[3]||(s[3]=[l("span",{class:"badge bg-success"},"轮到此玩家",-1)]))):y("",!0)])]),l("div",Te,[s[6]||(s[6]=l("div",{class:"stone-icon stone-white"},null,-1)),l("div",Ee,[l("div",Me,c(A()),1),e.value.current_player_id===e.value.player2_id?(i(),o("div",Re,s[5]||(s[5]=[l("span",{class:"badge bg-success"},"轮到此玩家",-1)]))):y("",!0)])]),s[11]||(s[11]=l("hr",null,null,-1)),l("div",Le,[l("div",Be,[s[7]||(s[7]=l("span",{class:"stat-label"},"已下子数：",-1)),l("span",Ne,c(m.value.length),1)]),l("div",Ve,[s[8]||(s[8]=l("span",{class:"stat-label"},"游戏状态：",-1)),l("span",qe,c(z()),1)]),l("div",Ae,[s[9]||(s[9]=l("span",{class:"stat-label"},"剩余时间：",-1)),l("span",{class:B(["stat-value",{"text-danger":h.value<=30}])},c(X(h.value)),3)])]),M.value?(i(),o("div",ze," 轮到你下棋了！ ")):y("",!0),e.value.status==="finished"?(i(),o("div",Ge,[s[10]||(s[10]=l("strong",null,"游戏结束！",-1)),e.value.winner_id?(i(),o("div",He," 获胜者: "+c(e.value.winner_id===e.value.player1_id?q():A()),1)):(i(),o("div",Pe," 游戏平局！ "))])):y("",!0),l("div",{class:"mt-3"},[l("button",{onClick:J,class:"btn btn-danger w-100"}," 退出游戏 ")])])):y("",!0)])])])]))]))}},Je=j(De,[["__scopeId","data-v-c28b74cd"]]);export{Je as default};
